<!doctype html>
<html lang="ko" data-theme="dark">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <meta name="theme-color" content="#111827" />
  <title>SmartChip 라이브 스플릿 추적기</title>
  <!-- 서버에서 전달된 초기 대회 ID (없으면 null) -->
  <script>
    window.INIT_MARATHON_ID = {{ init_mid if init_mid is not none else 'null' }};
  </script>
  <style>
    /* ===== Theme tokens (Dark default) ===== */
    :root{
      --bg:#0b0f17; --card:#111827; --muted:#9ca3af; --text:#e5e7eb;
      --accent:#22c55e; --accent2:#60a5fa; --warn:#f59e0b; --danger:#ef4444;
      --border:#1f2937; --alpha-bg: rgba(11,15,23,.8);
    }
    /* Light theme overrides */
    html[data-theme="light"]{
      --bg:#f7fafc; --card:#ffffff; --muted:#6b7280; --text:#111827;
      --accent:#16a34a; --accent2:#2563eb; --warn:#b45309; --danger:#b91c1c;
      --border:#e5e7eb; --alpha-bg: rgba(247,250,252,.9);
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; background:var(--bg); color:var(--text);
      font-family: system-ui, -apple-system, 'Segoe UI', Roboto, sans-serif;
    }
    a{color:#2563eb; text-decoration:none}
    html[data-theme="dark"] a{ color:#93c5fd; }

    .wrap{max-width:1100px; margin:0 auto; padding:env(safe-area-inset-top) 16px calc(72px + env(safe-area-inset-bottom)) 16px;}

    /* Top bar */
    .topbar{
      position:sticky; top:0; z-index:5; backdrop-filter:saturate(180%) blur(10px);
      background:var(--alpha-bg); border-bottom:1px solid var(--border);
      padding:10px 16px;
    }
    .toprow{display:flex; gap:10px; align-items:center; flex-wrap:wrap}
    .title{font-weight:700; font-size:18px}
    .spacer{flex:1}
    .btn{display:inline-flex; align-items:center; justify-content:center; gap:8px;
      padding:10px 14px; border-radius:12px; border:1px solid var(--border);
      background:var(--card); color:var(--text); font-weight:600; cursor:pointer}
    .btn.primary{background:#111b2d; border-color:#274060}
    html[data-theme="light"] .btn.primary{ background:#e8eefc; border-color:#c7d2fe; }
    .btn.ghost{background:transparent}
    .chip{display:inline-block; padding:4px 8px; border-radius:999px; font-size:12px; border:1px solid var(--border); color:var(--muted)}

    /* Grid/list */
    .grid{display:grid; grid-template-columns: repeat(auto-fill,minmax(260px,1fr)); gap:12px; margin-top:12px;}
    .card{
      background:var(--card); border:1px solid var(--border); border-radius:16px; padding:14px;
      box-shadow: 0 4px 10px rgba(0,0,0,.08);
    }
    html[data-theme="dark"] .card{ box-shadow: 0 4px 10px rgba(0,0,0,.25); }
    .card h3{margin:0 0 4px; font-size:16px}
    .small{color:var(--muted); font-size:12px}

    /* Race view */
    .section{margin-top:18px}
    .section-head{display:flex; align-items:center; gap:8px; margin-bottom:6px}
    .section-head h2{margin:0; font-size:16px}
    .toggle{margin-left:auto}
    .table{width:100%; border-collapse:collapse; border-radius:12px; overflow:hidden; border:1px solid var(--border)}
    .table th,.table td{padding:10px; border-bottom:1px solid var(--border); text-align:center}
    .table th{background:rgba(0,0,0,.06); color:#334155; font-weight:700}
    html[data-theme="dark"] .table th{ background:#0f1624; color:#cbd5e1; }
    .mono{font-family: ui-monospace,SFMono-Regular,Menlo,Monaco,Consolas,monospace}

    /* Row card (mobile) */
    .rowcard{
      display:flex; flex-direction:column; gap:6px; margin-bottom:10px;
      border:1px solid var(--border); border-radius:14px; padding:12px; background:rgba(0,0,0,.03);
    }
    html[data-theme="dark"] .rowcard{ background:#0f1624; }
    .row1{display:flex; align-items:center; gap:8px; flex-wrap:wrap}
    .name{font-weight:700; font-size:16px}
    .bib{color:#065f46; background:#d1fae5; padding:2px 8px; border-radius:999px; font-weight:700}
    html[data-theme="dark"] .bib{ color:#d1fae5; background:#064e3b; }
    .status{color:#14532d; background:#bbf7d0; border:1px solid #16a34a}
    .status.run{color:#713f12; background:#fde68a; border-color:#a16207}
    .status.none{color:#334155; background:#e5e7eb; border-color:#cbd5e1}
    html[data-theme="dark"] .status{color:#bbf7d0; background:#052e1f; border-color:#115e3b}
    html[data-theme="dark"] .status.run{color:#fde68a; background:#3b2f05; border-color:#a16207}
    html[data-theme="dark"] .status.none{color:#cbd5e1; background:#1f2937; border-color:#374151}
    .row2,.row3,.row4{font-size:13px}
    .muted{color:var(--muted)}
    details>summary{cursor:pointer; color:#2563eb; outline:none}
    html[data-theme="dark"] details>summary{ color:#93c5fd; }
    .actions{display:flex; gap:8px; align-items:center; margin-top:6px}
    .btn.inline{padding:6px 10px; font-size:13px; border-radius:10px}

    /* Inputs */
    .input{
      flex:1; min-width:140px; padding:12px; border-radius:12px; border:1px solid var(--border);
      background:var(--card); color:var(--text); width:100%; font-size:14px;
    }

    /* FAB (refresh controls) */
    .fab{
      position:fixed; right:16px; bottom:calc(16px + env(safe-area-inset-bottom));
      display:flex; gap:8px; z-index:10;
    }
    .seg{display:flex; background:var(--card); border:1px solid var(--border); border-radius:12px; overflow:hidden}
    .seg button{padding:10px 12px; background:transparent; color:var(--text); border:0; font-weight:700}
    .seg button.active{background:rgba(37, 99, 235, .15)}
    html[data-theme="dark"] .seg button.active{ background:#12233b; color:#93c5fd; }

    /* Desktop table visible at >= 900px */
    .only-desktop{display:none}
    @media (min-width: 900px){
      .only-desktop{display:block}
      .only-mobile{display:none}
    }
    /* 1줄 리스트 */
    .compact-list{display:flex; flex-direction:column; gap:6px;}
    .compact-item{
      display:flex; align-items:center; gap:8px;
      padding:10px 12px; border:1px solid var(--border); border-radius:12px;
      background:var(--card);
    }
    .compact-item .col{min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .compact-item .name{font-weight:700;}
    .compact-item .bib{font-weight:700; padding:2px 8px; border-radius:999px;}
    html[data-theme="dark"] .compact-item .bib{ color:#d1fae5; background:#064e3b; }
    html[data-theme="light"] .compact-item .bib{ color:#065f46; background:#d1fae5; }
    .compact-item .status{border:1px solid var(--border); border-radius:999px; padding:2px 8px; }
    .compact-item .split,.compact-item .eta,.compact-item .fin{font-family: ui-monospace,SFMono-Regular,Menlo,Consolas,monospace; font-size:12px; color:var(--muted);}
    .compact-item .actions{display:flex; gap:6px; margin-left:auto;}
    .compact-item .btn.inline{padding:6px 10px; font-size:12px; border-radius:10px;}
    .compact-scroll{overflow-x:auto; -webkit-overflow-scrolling:touch;}
    .mlist{min-width:640px; display:flex; flex-direction:column; gap:6px; padding-bottom:4px;}
    .mrow{
      display:flex; align-items:center; gap:10px;
      padding:10px 12px; border:1px solid var(--border); border-radius:12px;
      background:var(--card);
    }
    .mrow .c{min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;}
    .mrow .c.name{flex:0 0 160px; font-weight:700;}
    .mrow .c.pt{flex:0 0 120px;}
    .mrow .c.eta{flex:0 0 150px; font-variant-numeric: tabular-nums; color:var(--muted);}
    .mrow .c.clock{flex:0 0 150px; font-variant-numeric: tabular-nums; color:var(--muted);}
    .mrow .actions{margin-left:auto; display:flex; gap:6px;}
    .mrow .btn.inline{padding:6px 10px; font-size:12px; border-radius:10px;}
    /* 숫자 정렬용 공통 */
    .num{ font-variant-numeric: tabular-nums; color: var(--muted); }

    /* 기존 .clock 유지 + net 칸 추가 */
    .mrow .c.clock{ flex:0 0 140px; }
    .mrow .c.net{   flex:0 0 120px; }

  </style>
</head>
<body>
  <div class="topbar">
    <div class="toprow">
      <div class="title">SmartChip 라이브 스플릿</div>
      <span class="chip only-desktop">모바일 최적화</span>
      <div class="spacer"></div>
      <button class="btn ghost" id="themeBtn" aria-pressed="false" title="라이트/다크 전환">🌗 테마</button>
    </div>
  </div>

  <div class="wrap">
    <!-- 1) 대회 리스트 -->
    <div id="viewList">
      <div class="small muted">대회를 선택하세요. (카드는 /race/&lt;id&gt; 링크로 열립니다)</div>
      <div id="marathonGrid" class="grid"></div>
    </div>

    <!-- 2) 특정 대회 보기 (종목 그룹) -->
    <div id="viewRace" style="display:none;">
      <div class="section-head" style="margin-top:4px;">
        <a class="btn" href="/">← 목록</a>
        <div id="raceTitle" style="font-weight:700;"></div>
        <span class="small muted" id="raceMeta"></span>
        <div class="spacer"></div>
        <button class="btn" onclick="copyShare()">공유</button>
      </div>

      <!-- 참가자 추가 -->
      <div class="card" style="margin-top:8px;">
        <div class="small muted" style="margin-bottom:6px;">참가자 추가</div>
        <div style="display:flex; gap:8px; flex-wrap:wrap;">
          <input id="alias" class="input" placeholder="성명(표시용)" />
          <input id="nameorbib" class="input" placeholder="배번 또는 이름 (nameorbibno)" />
          <button class="btn primary" onclick="addP()">+ 추가</button>
          <div class="spacer"></div>
          <button class="btn" onclick="downloadCSV()">CSV</button>
        </div>
      </div>

      <div id="groupContainer" class="section"></div>
    </div>
  </div>

  <!-- 하단 FAB: 새로고침 간격 / 수동 새로고침 -->
  <div class="fab" id="fab" style="display:none;">
    <div class="seg" role="tablist" aria-label="자동 새로고침 간격">
      <button class="segbtn" data-sec="15">15s</button>
      <button class="segbtn active" data-sec="30">30s</button>
      <button class="segbtn" data-sec="60">60s</button>
    </div>
    <button class="btn" onclick="manualRefresh()">새로고침</button>
  </div>

<script>
let REFRESH = 30, timer = null;
let marathons = [];
let currentMarathon = null;
let items = []; // 참가자 목록(선택된 대회)

// ...기존 스크립트 상단 공용 함수들 근처에 추가
function getPred(last){
  if(!last) return null;
  return last.prediction || last.pred || null;
}
/* ===== Theme handling ===== */
const THEME_KEY = 'sc_theme';
function applyTheme(theme){
  const html = document.documentElement;
  html.setAttribute('data-theme', theme);
  const meta = document.querySelector('meta[name="theme-color"]');
  if(meta){ meta.setAttribute('content', theme==='dark' ? '#111827' : '#f7fafc'); }
  const btn = document.getElementById('themeBtn');
  if(btn){
    btn.setAttribute('aria-pressed', theme==='dark' ? 'true':'false');
    btn.textContent = theme==='dark' ? '🌙 다크' : '🌞 라이트';
  }
  localStorage.setItem(THEME_KEY, theme);
}
function initTheme(){
  const saved = localStorage.getItem(THEME_KEY);
  const sysDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
  applyTheme(saved || (sysDark ? 'dark' : 'light'));
}
document.addEventListener('click', (e)=>{
  if(e.target && e.target.id === 'themeBtn'){
    const cur = document.documentElement.getAttribute('data-theme') || 'dark';
    applyTheme(cur === 'dark' ? 'light' : 'dark');
  }
});

/* ===== Common ===== */
function $(id){ return document.getElementById(id); }

function lastPointLabel(last){
  const L = last?.splits?.length||0;
  if(!L) return null;
  const s = last.splits[L-1];
  return (s.point_label || s.point || null);
}
function lastPassClock(last){
  const L = last?.splits?.length||0;
  if(!L) return null;
  const s = last.splits[L-1];
  const v = (s.pass_clock || '').trim();
  return v || null;
}

// 5초 버퍼용: "HH:MM:SS" → +5초 → "HH:MM:SS"
function addSec(hms, add=5){
  if(!hms) return null;
  const m = /^(\d{1,2}):([0-5]?\d):([0-5]?\d)$/.exec(hms.trim());
  if(!m) return null;
  let h=+m[1], mi=+m[2], s=+m[3] + add;
  mi += Math.floor(s/60); s%=60;
  h  += Math.floor(mi/60); mi%=60;
  h%=24;
  return `${h.toString().padStart(2,'0')}:${mi.toString().padStart(2,'0')}:${s.toString().padStart(2,'0')}`;
}

// 마지막 스플릿 포인트 라벨만
function lastPointLabel(last){
  const L = last?.splits?.length||0;
  if(!L) return null;
  const s = last.splits[L-1];
  return (s.point_label || s.point || null);
}

// --- 정렬 유틸 ---
function kmFromLabel(lbl){
  if(!lbl) return null;
  const m = /([0-9]+(?:\.[0-9]+)?)\s*km/i.exec(lbl);
  return m ? parseFloat(m[1]) : null;
}
function secFromClock(hms){
  if(!hms) return null;
  const m = /^(\d{1,2}):([0-5]?\d):([0-5]?\d)$/.exec(hms.trim());
  if(!m) return null;
  return (+m[1])*3600 + (+m[2])*60 + (+m[3]);
}
function secFromNet(net){
  if(!net) return null;
  const p = net.trim().split(':').map(x=>+x);
  if(p.length===3) return p[0]*3600 + p[1]*60 + p[2];
  if(p.length===2) return p[0]*60 + p[1];
  return null;
}
function lastSplit(last){
  if(!last || !last.splits || !last.splits.length) return null;
  return last.splits[last.splits.length-1];
}
function lastKm(last){
  const s = lastSplit(last); if(!s) return -1; // 시작 전은 -1로 끝으로 밀기
  if (s.point_km != null) return Number(s.point_km);
  const k = kmFromLabel(s.point_label || s.point);
  return (k!=null ? k : -1);
}
function lastClockSec(last){
  const s = lastSplit(last); if(!s) return Number.POSITIVE_INFINITY;
  const t = secFromClock(s.pass_clock);
  return (t!=null ? t : Number.POSITIVE_INFINITY);
}
function lastNetSec(last){
  const s = lastSplit(last); if(!s) return Number.POSITIVE_INFINITY;
  const t = secFromNet(s.net_time);
  return (t!=null ? t : Number.POSITIVE_INFINITY);
}
/* 정렬 기준: 
   1. 완주 여부 (완주자 우선)
   2. 이동 거리 (내림차순)
   3. 완주 기록 (오름차순, 완주자에게만 유효)
   4. 마지막 통과 시각 (오름차순)
   5. 이름 (오름차순)
*/
function compareParticipantFast(a, b){  
  const la = a._last || {}, lb = b._last || {};
  const pa = getPred(la), pb = getPred(lb);               // ✅ 추가
  const fa = (pa && pa.finished) ? 1 : 0;                  // ← la.pred → pa
  const fb = (pb && pb.finished) ? 1 : 0;                  // ← lb.pred → pb
  if (fa !== fb) return fb - fa; // 1. 완주자 우선

  const ka = lastKm(la), kb = lastKm(lb);
  if (ka !== kb) return kb - ka; // 2. 더 멀리 간 순서

  // 완주한 경우, net_time (완주 기록)으로 우선 정렬
  if (fa && fb) {
    const na = lastNetSec(la), nb = lastNetSec(lb);
    if (na !== nb) return na - nb; // 3. 완주 기록 빠른 순
  }

  const ca = lastClockSec(la), cb = lastClockSec(lb);
  if (ca !== cb) return ca - cb; // 4. 통과 시각 빠른 순

  return (a.alias||'').localeCompare(b.alias||'');
}

/* ========== 대회 리스트 ========== */
async function loadMarathons(){
  const r = await fetch('/api/marathons');
  marathons = await r.json();
  renderMarathonList();
  if (window.INIT_MARATHON_ID) openRace(window.INIT_MARATHON_ID);
}

function renderMarathonList(){
  const g = $('marathonGrid'); g.innerHTML = '';
  if(!marathons.length){
    g.innerHTML = '<div class="card small muted">등록된 대회가 없습니다. 관리자에서 대회를 등록하세요.</div>';
    return;
  }
  for(const m of marathons){
    const div = document.createElement('div');
    div.className = 'card';
    div.innerHTML = `
      <h3>${m.name}</h3>
      <div class="small muted">거리: ${m.total_distance_km}km · 새로고침: ${m.refresh_sec}s</div>
      <div style="margin-top:10px;">
        <a class="btn" style="width:100%; justify-content:center" href="/race/${m.id}">이 대회 보기</a>
      </div>
    `;
    g.appendChild(div);
  }
}

function openRace(mid){
  currentMarathon = Number(mid);
  const m = marathons.find(x => x.id === currentMarathon);
  $('raceTitle').textContent = m ? m.name : `대회 #${currentMarathon}`;
  let metaText = m ? `ID ${m.id} · ${m.total_distance_km}km · ${m.refresh_sec}s` : '';
  if (m && m.event_date) metaText += ` · ${m.event_date}`;
  $('raceMeta').textContent = metaText;
  $('viewList').style.display = 'none';
  $('viewRace').style.display = 'block';
  $('fab').style.display = 'flex';
  loadParticipants();
}

function copyShare(){
  const url = `${location.origin}/race/${currentMarathon}`;
  navigator.clipboard.writeText(url).then(()=> alert('링크 복사됨')).catch(()=> prompt('링크 복사 실패. 수동 복사:', url));
}

/* ========== 참가자 & 그룹 렌더 ========== */
async function loadParticipants(){
  const r = await fetch('/api/participants?marathon_id='+currentMarathon);
  items = await r.json();
  await fetchAll();
  renderGroups();
  setupAutoRefresh(); // 첫 로딩 시 자동 새로고침 적용
}

async function fetchOne(p){
  const r = await fetch('/api/participant_data?participant_id='+p.id);
  const j = await r.json();
  p._last = j;
}

async function fetchAll(){
  const ps = items.map(p => fetchOne(p).catch(()=> p._last={msg:'로드 오류'}));
  await Promise.all(ps);
}

function groupOrder(name){
  // 1. 명시적 순서 정의 (Full, Half 등)
  const order = { 
    "Full": 1, "32K": 2, "Half": 3, 
    "10K": 4, "10km": 4, 
    "5K": 5, "5km": 5, 
    "3K": 6, "3km": 6,
    "미분류": 99
  };
  if (name in order) return order[name];

  // 2. 숫자 기반 종목명 처리 (e.g., "25km")
  const m = name.match(/^(\d+(?:\.\d+)?)/);
  if (m) return 10 - parseFloat(m[1]); // 숫자가 클수록 앞 순서 (10 - 25 = -15)

  // 3. 그 외
  return 90;
}

function lastSplitsText(last){
  if(!last || !last.splits || !last.splits.length) return '데이터 없음';
  const L = last.splits.length;
  const tail = last.splits.slice(Math.max(0, L-2)); // 최근 2개
  return tail.map(s => `${s.point_label||s.point}: ${s.net_time||s.time} (${s.pass_clock}|${s.pace})`).join('\n');
}

function allSplitsText(last){
  if(!last || !last.splits || !last.splits.length) return '데이터 없음';
  return last.splits.map(s => `${s.point_label||s.point}: ${s.net_time||s.time} (${s.pass_clock}|${s.pace})`).join('\n');
}

function lastPointLabel(last){
  const L = last?.splits?.length||0; if(!L) return null;
  const s = last.splits[L-1];
  return (s.point_label || s.point || null);
}
function lastPassClock(last){
  const L = last?.splits?.length||0; if(!L) return null;
  const v = (last.splits[L-1].pass_clock || '').trim();
  return v || null;
}
function lastNetTime(last){
  const L = last?.splits?.length||0; if(!L) return null;
  const v = (last.splits[L-1].net_time || '').trim();
  return v || null;
}

function renderGroups(){
  const wrap = $('groupContainer');
  wrap.innerHTML = '';

  // 종목 그룹핑
  const buckets = {};
  for (const it of items) {
    // 그룹명 결정: 1) 실시간 데이터의 race_label -> 2) 참가자 정보의 race_label -> 3) '미분류'
    const g = (it._last && it._last.race_label)
      ? it._last.race_label
      : (it.race_label || '미분류');

    (buckets[g] ||= []).push(it);
  }
  const names = Object.keys(buckets).sort((a,b)=> groupOrder(a)-groupOrder(b) || a.localeCompare(b));

  for(const gname of names){
    const list = buckets[gname];
    const sorted = list.slice().sort(compareParticipantFast);

    const sec = document.createElement('div');
    sec.className = 'section';

    const head = document.createElement('div');
    head.className = 'section-head';
    head.innerHTML = `<h2>${gname} (${sorted.length}명)</h2>`;
    const toggle = document.createElement('button');
    toggle.className = 'btn ghost toggle';
    toggle.textContent = '접기/펼치기';
    head.appendChild(toggle);
    sec.appendChild(head);

    /* ===== 모바일: 1줄 리스트(이름 · 현재 포인트 · 통과시각 · 타임 · 원문 · 삭제) ===== */
    const mobileWrap = document.createElement('div');
    mobileWrap.className = 'only-mobile compact-scroll';
    const mlist = document.createElement('div');
    mlist.className = 'mlist';

    for (const it of sorted){
      const last = it._last || {};
      const pt   = lastPointLabel(last) || '-';
      const clk  = lastPassClock(last)  || '-';  // PASS TIME(시계 시각)
      const net  = lastNetTime(last)    || '-';  // TIME(경과 시간)

      const row = document.createElement('div');
      row.className = 'mrow';
      row.innerHTML = `
        <span class="c name">${it.alias||'-'}</span>
        <span class="c pt">${pt}</span>
        <span class="c clock num" title="통과 시각(PASS TIME)">${clk}</span>
        <span class="c net num"   title="타임(TIME, 경과시간)">${net}</span>
        <span class="actions">
          ${last.url ? `<a class="btn inline" href="${last.url}" target="_blank">원문</a>` : `<span class="btn inline" style="opacity:.6;pointer-events:none">원문</span>`}
          <button class="btn inline" onclick="delRow(${it.id})">삭제</button>
        </span>
      `;
      mlist.appendChild(row);
    }
    mobileWrap.appendChild(mlist);
    sec.appendChild(mobileWrap);

    /* ===== 데스크톱 표(그대로 유지) ===== */
    const tblWrap = document.createElement('div');
    tblWrap.className = 'only-desktop';
    const tbl = document.createElement('table');
    tbl.className = 'table';
    tbl.innerHTML = `
      <thead>
        <tr>
          <th>성명</th><th>배번호/이름</th><th>포인트/시간</th>
          <th>상태</th><th>다음 포인트 ETA</th><th>피니시 ETA</th>
          <th>피니시 넷타임 예측</th><th>원문</th><th>삭제</th>
        </tr>
      </thead><tbody></tbody>
    `;
    const tb = tbl.querySelector('tbody');
    for(const it of sorted){
      const last = it._last || {};
      let pts = '데이터 없음';
      if(last.splits?.length){
        pts = last.splits.map(s => `${s.point_label||s.point}: ${s.net_time||s.time} (${s.pass_clock}|${s.pace})`).join('\n');
      }else if(last.msg){ pts = last.msg; }
      const pred = getPred(last);                                 // ✅ 추가
      const statusTxt = (pred && pred.finished) ? '완주' : ((last.splits && last.splits.length) ? '주행중' : '-');

      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${it.alias||'-'}</td>
        <td>${it.nameorbibno||it.bib||'-'}</td>
        <td class="mono" style="white-space:pre; text-align:left">${pts}</td>
        <td>${statusTxt}</td>
        <td>${pred?.next_point_km ? (Number(pred.next_point_km).toFixed(1)+'km @ '+(pred.next_point_eta||'-')) : '-'}</td>
        <td>${pred?.finish_eta||'-'}</td>
        <td class="mono">${pred?.finish_net_pred||'-'}</td>
        <td>${last.url ? `<a href="${last.url}" target="_blank">원문</a>` : '-'}</td>
        <td><button class="btn inline" onclick="delRow(${it.id})">삭제</button></td>
      `;
      tb.appendChild(tr);
    }
    tblWrap.appendChild(tbl);
    sec.appendChild(tblWrap);

    // 접기/펼치기
    let collapsed = false;
    toggle.addEventListener('click', ()=>{
      collapsed = !collapsed;
      mobileList.style.display = collapsed ? 'none' : 'block';
      tblWrap.style.display = collapsed ? 'none' : 'block';
    });

    wrap.appendChild(sec);
  }
}

/* ========== 동작 컨트롤 ========== */
async function addP(){
  if(!currentMarathon){ alert('대회를 먼저 선택하세요.'); return; }
  const alias = $('alias').value.trim();
  const nameorbibno = $('nameorbib').value.trim();
  if(!nameorbibno){ alert('배번/이름은 필수'); return; }
  const r = await fetch('/api/participants',{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({marathon_id: currentMarathon, alias, nameorbibno})
  });
  if(r.ok){ $('nameorbib').value=''; await loadParticipants(); }
  else{ alert('추가 실패'); }
}

async function delRow(id){
  await fetch('/api/participants/'+id,{method:'DELETE'});
  await loadParticipants();
}

function setupAutoRefresh(){
  if(timer) clearInterval(timer);
  timer = setInterval(async ()=>{ await fetchAll(); renderGroups(); }, REFRESH*1000);
}

// FAB segmented control
for(const b of document.querySelectorAll('.segbtn')){
  b.addEventListener('click', ()=>{
    for(const x of document.querySelectorAll('.segbtn')) x.classList.remove('active');
    b.classList.add('active');
    REFRESH = Number(b.dataset.sec||30);
    setupAutoRefresh();
  });
}
async function manualRefresh(){
  await fetchAll(); renderGroups();
}

/* CSV 다운로드 */
function downloadCSV(){
  const buckets = {};
  for(const it of items){
    const g = (it._last && it._last.group) ? it._last.group : '미분류';
    (buckets[g] ||= []).push(it);
  }
  const names = Object.keys(buckets).sort((a,b)=> groupOrder(a)-groupOrder(b) || a.localeCompare(b));

  const rows = [];
  for(const g of names){
    const sorted = buckets[g].slice().sort(compareParticipantFast);
    for(const it of sorted){
      const last = it._last || {};
      const name = it.alias||'-';
      const bib  = it.nameorbibno||it.bib||'-';
      const cols = [];
      if(last.splits && last.splits.length){
        for(const s of last.splits){ cols.push(`${s.point_label||s.point} ${s.net_time||s.time}`); }
        cols.push(last.pred?.finish_net_pred? `FINISH ${last.pred.finish_net_pred}` : 'FINISH -');
      }else{
        cols.push('데이터 없음');
      }
      rows.push([g, name, bib, ...cols]);
    }
  }
  const csv = rows.map(r => r.map(x => '"'+String(x).replaceAll('"','""')+'"').join(',')).join('\r\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = 'smartchip_groups_sorted.csv'; a.click();
  URL.revokeObjectURL(url);
}

/* init */
initTheme();
loadMarathons();
</script>
</body>
</html>
